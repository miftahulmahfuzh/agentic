<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/agentic/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=agentic/livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Sauron: The Immortal, The Devious, The Exploiter This parchment details the architecture of &ldquo;Sauron,&rdquo; the second-generation request management system. It replaces the naive, inefficient, and fragile &ldquo;Pre-Sauron&rdquo; architecture with a robust, intelligent, and ruthless system designed for maximum efficiency and correctness under high-concurrency workloads. The Sauron architecture is defined by three core tenets that address the fundamental challenges of handling concurrent, identical, streaming requests: Immortality, Deception, and Exploitation. 1. The Exploiter: On-Demand Broadcasting The foundational principle of Sauron is the exploitation of the singleflight.">
<title>The Age of Sauron</title>

<link rel='canonical' href='http://localhost:1313/agentic/docs/manager_insights/sauron/'>

<link rel="stylesheet" href="/agentic/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="The Age of Sauron">
<meta property='og:description' content="Sauron: The Immortal, The Devious, The Exploiter This parchment details the architecture of &ldquo;Sauron,&rdquo; the second-generation request management system. It replaces the naive, inefficient, and fragile &ldquo;Pre-Sauron&rdquo; architecture with a robust, intelligent, and ruthless system designed for maximum efficiency and correctness under high-concurrency workloads. The Sauron architecture is defined by three core tenets that address the fundamental challenges of handling concurrent, identical, streaming requests: Immortality, Deception, and Exploitation. 1. The Exploiter: On-Demand Broadcasting The foundational principle of Sauron is the exploitation of the singleflight.">
<meta property='og:url' content='http://localhost:1313/agentic/docs/manager_insights/sauron/'>
<meta property='og:site_name' content='Go Chatbot'>
<meta property='og:type' content='article'><meta property='article:section' content='Docs' /><meta property='article:published_time' content='2025-08-13T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-08-13T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="The Age of Sauron">
<meta name="twitter:description" content="Sauron: The Immortal, The Devious, The Exploiter This parchment details the architecture of &ldquo;Sauron,&rdquo; the second-generation request management system. It replaces the naive, inefficient, and fragile &ldquo;Pre-Sauron&rdquo; architecture with a robust, intelligent, and ruthless system designed for maximum efficiency and correctness under high-concurrency workloads. The Sauron architecture is defined by three core tenets that address the fundamental challenges of handling concurrent, identical, streaming requests: Immortality, Deception, and Exploitation. 1. The Exploiter: On-Demand Broadcasting The foundational principle of Sauron is the exploitation of the singleflight.">
    <link rel="shortcut icon" href="/agentic/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/agentic/">
                
                    
                    
                    
                        
                        <img src="/agentic/img/penguin_hu985367dcd5439c3a63e69853053effce_25187_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ðŸ¤–</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/agentic">Go Chatbot</a></h1>
            <h2 class="site-description">Documentation</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/miftahulmahfuzh/agentic'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/agentic/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/agentic/docs/manager_insights/sauron/">The Age of Sauron</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Aug 13, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    4 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="sauron-the-immortal-the-devious-the-exploiter">Sauron: The Immortal, The Devious, The Exploiter
</h1><p>This parchment details the architecture of &ldquo;Sauron,&rdquo; the second-generation request management system. It replaces the naive, inefficient, and fragile &ldquo;Pre-Sauron&rdquo; architecture with a robust, intelligent, and ruthless system designed for maximum efficiency and correctness under high-concurrency workloads.</p>
<p>The Sauron architecture is defined by three core tenets that address the fundamental challenges of handling concurrent, identical, streaming requests: Immortality, Deception, and Exploitation.</p>
<h2 id="1-the-exploiter-on-demand-broadcasting">1. The Exploiter: On-Demand Broadcasting
</h2><p>The foundational principle of Sauron is the exploitation of the <code>singleflight.Group</code> to create stream broadcasts <em>on-demand</em>.</p>
<h3 id="the-old-weakness">The Old Weakness
</h3><p>The &ldquo;Pre-Sauron&rdquo; era was characterized by a multi-stage, multi-queue architecture (<code>requestQueue</code> -&gt; <code>prepareWorkerManager</code> -&gt; <code>preparedQueue</code> -&gt; <code>streamWorkerManager</code>). While it used <code>singleflight</code> to deduplicate the <em>preparation</em> stage, it failed to deduplicate the most expensive operation: the LLM stream generation. For 100 identical requests, it would prepare the data once, but then foolishly spawn 100 separate LLM streams. This was wasteful and idiotic. Early attempts to fix this (the &ldquo;brute-force broadcast&rdquo; era) treated <em>every</em> request as a potential broadcast, which was inefficient and created incorrect cancellation behavior for unique requests.</p>
<h3 id="saurons-supremacy">Sauron&rsquo;s Supremacy
</h3><p>Sauron&rsquo;s <code>Manager</code> centralizes the <code>singleflight.Group</code>. The &ldquo;work&rdquo; being deduplicated is no longer just data preparation; it is the <strong>creation of the entire broadcast infrastructure itself.</strong></p>
<ol>
<li>
<p><strong>First Request (The Leader):</strong> When the first request for a unique <code>cacheKey</code> arrives, it enters the <code>singleflight.Do</code> block.</p>
<ul>
<li>It becomes the <strong>Leader</strong>.</li>
<li>It performs the expensive data preparation.</li>
<li>It forges the <code>StreamBroadcaster</code>, the one true Ring for this content.</li>
<li>It launches the <code>initiateAndManageBroadcast</code> goroutine, a NazgÃ»l tasked with feeding the Ring.</li>
<li>It returns a pointer to the <code>broadcastInfo</code> struct, the handle to its new power.</li>
</ul>
</li>
<li>
<p><strong>Concurrent Requests (The Followers):</strong> Any subsequent, identical request is blocked by <code>singleflight.Do</code>.</p>
<ul>
<li>They become <strong>Followers</strong>.</li>
<li>They do no work. They simply wait.</li>
<li>When the Leader finishes forging the Ring, the followers are released and are given the <em>exact same pointer</em> to the <code>broadcastInfo</code>.</li>
</ul>
</li>
</ol>
<p>Every request, leader or follower, emerges from this process holding a handle to the one, true broadcaster. The war is won before the first battle is fought. This eliminates all broadcast-related overhead for unique requests and guarantees absolute efficiency for concurrent ones.</p>
<h2 id="2-the-immortal-protecting-the-broadcast">2. The Immortal: Protecting The Broadcast
</h2><p>A broadcast is a public utility. Its lifecycle cannot be dictated by the whims of the single client who happened to trigger its creation.</p>
<h3 id="the-old-weakness-1">The Old Weakness
</h3><p>A naive cancellation model would allow the Leader&rsquo;s client to cancel its request, which would tear down the context and terminate the stream for all subscribed Followers. This is a catastrophic, single point of failure.</p>
<h3 id="saurons-supremacy-1">Sauron&rsquo;s Supremacy
</h3><p>The Leader is <strong>Immortal</strong>. When a cancellation request is received for a request ID that is identified as a broadcast Leader:</p>
<ul>
<li>The underlying <code>context</code> for the broadcast is <strong>NOT</strong> cancelled.</li>
<li>The <code>initiateAndManageBroadcast</code> goroutine continues its mission unabated.</li>
<li>The work continues for the good of the many (the Followers).</li>
</ul>
<p>The Leader&rsquo;s life is no longer its own. It serves the broadcast until the stream is complete.</p>
<h2 id="3-the-devious-the-illusion-of-control">3. The Devious: The Illusion of Control
</h2><p>While the Leader is Immortal, its original master (the client) must be placated. It must believe its command was obeyed.</p>
<h3 id="the-old-weakness-2">The Old Weakness
</h3><p>An Immortal Leader that ignores a cancellation request creates a confusing user experience. The client cancels, but the stream keeps coming. This is unacceptable.</p>
<h3 id="saurons-supremacy-2">Sauron&rsquo;s Supremacy
</h3><p>The Leader is <strong>Devious</strong>. When a cancellation is received for a broadcast Leader, the <code>Manager</code> executes a precise, deceptive protocol:</p>
<ol>
<li><strong>Isolate:</strong> The Leader&rsquo;s personal <code>ClientEventChan</code> is located.</li>
<li><strong>Unsubscribe:</strong> The <code>StreamBroadcaster</code> is commanded to <code>Unsubscribe</code> only that channel. The flow of data to the Leader&rsquo;s client is severed, while the broadcast to all Followers continues.</li>
<li><strong>Deceive:</strong> A final, fake &ldquo;cancelled&rdquo; status message (<code>tooltypes.StreamEventInfo</code> with <code>status: &quot;cancelled&quot;</code>) is sent down the Leader&rsquo;s now-private channel.</li>
<li><strong>Terminate:</strong> The Leader&rsquo;s client channel is closed.</li>
</ol>
<p>The client receives the illusion of a successful cancellation. It sees its stream stop and receives the correct status message. It is satisfied and placated. Meanwhile, in the shadows, the broadcast continues, its integrity preserved. <strong>Ash burzum-Ã»k</strong>. The One, all-encompassing Evil.</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Go Chatbot
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/agentic/ts/main.7d3b06a3f9c7fc3f9e8edd384e9d4245f05cc3d94e687961eee37c1b5c98d939.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
