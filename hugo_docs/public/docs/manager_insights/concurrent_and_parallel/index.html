<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/agentic/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=agentic/livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Concurrency &amp; Parallelism: The Ops Center of manager.go Welcome to the mission briefing. Our manager.go file is the central nervous system of our chatbot operation, much like an MI6 Ops Center. It needs to handle a flood of incoming requests from agents (users) all over the world. To do this without melting down, it masterfully employs the arts of concurrency and parallelism. Concurrency: Juggling Multiple Missions at Once Concurrency is about structuring our code to handle many things at once, even if we only have one CPU core doing the work.">
<title>Concurrent &amp; Parallel</title>

<link rel='canonical' href='http://localhost:1313/agentic/docs/manager_insights/concurrent_and_parallel/'>

<link rel="stylesheet" href="/agentic/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Concurrent & Parallel">
<meta property='og:description' content="Concurrency &amp; Parallelism: The Ops Center of manager.go Welcome to the mission briefing. Our manager.go file is the central nervous system of our chatbot operation, much like an MI6 Ops Center. It needs to handle a flood of incoming requests from agents (users) all over the world. To do this without melting down, it masterfully employs the arts of concurrency and parallelism. Concurrency: Juggling Multiple Missions at Once Concurrency is about structuring our code to handle many things at once, even if we only have one CPU core doing the work.">
<meta property='og:url' content='http://localhost:1313/agentic/docs/manager_insights/concurrent_and_parallel/'>
<meta property='og:site_name' content='Go Chatbot'>
<meta property='og:type' content='article'><meta property='article:section' content='Docs' /><meta property='article:published_time' content='2025-08-13T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-08-13T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="Concurrent & Parallel">
<meta name="twitter:description" content="Concurrency &amp; Parallelism: The Ops Center of manager.go Welcome to the mission briefing. Our manager.go file is the central nervous system of our chatbot operation, much like an MI6 Ops Center. It needs to handle a flood of incoming requests from agents (users) all over the world. To do this without melting down, it masterfully employs the arts of concurrency and parallelism. Concurrency: Juggling Multiple Missions at Once Concurrency is about structuring our code to handle many things at once, even if we only have one CPU core doing the work.">
    <link rel="shortcut icon" href="/agentic/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/agentic/">
                
                    
                    
                    
                        
                        <img src="/agentic/img/penguin_hu985367dcd5439c3a63e69853053effce_25187_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ðŸ¤–</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/agentic">Go Chatbot</a></h1>
            <h2 class="site-description">Documentation</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/miftahulmahfuzh/agentic'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/agentic/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/agentic/docs/manager_insights/concurrent_and_parallel/">Concurrent &amp; Parallel</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Aug 13, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    7 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="concurrency--parallelism-the-ops-center-of-managergo">Concurrency &amp; Parallelism: The Ops Center of <code>manager.go</code>
</h1><p>Welcome to the mission briefing. Our <code>manager.go</code> file is the central nervous system of our chatbot operation, much like an MI6 Ops Center. It needs to handle a flood of incoming requests from agents (users) all over the world. To do this without melting down, it masterfully employs the arts of <strong>concurrency</strong> and <strong>parallelism</strong>.</p>
<h2 id="concurrency-juggling-multiple-missions-at-once">Concurrency: Juggling Multiple Missions at Once
</h2><p>Concurrency is about structuring our code to handle many things at once, even if we only have one CPU core doing the work. It&rsquo;s about switching between tasks efficiently so that no single task blocks the entire system.</p>
<p>In <code>manager.go</code>, concurrency is achieved primarily through <strong>Goroutines</strong> and <strong>Channels</strong>.</p>
<h3 id="the-tools-of-concurrency">The Tools of Concurrency:
</h3><ol>
<li>
<p><strong>Goroutines (<code>go func(...)</code>)</strong>: Every time you see <code>go ...</code>, we&rsquo;re launching a new, independent task. It could be processing a new request, the janitor cleaning up old files, or a &ldquo;leader&rdquo; generating a response stream for multiple listeners. They all run without waiting for each other to finish.</p>
</li>
<li>
<p><strong>Channels (<code>chan</code>)</strong>: This is our secure communication line.</p>
<ul>
<li><code>requestQueue</code>: This is the &ldquo;mission assignment&rdquo; desk. New requests arrive here and wait to be picked up by a worker from the pool.</li>
<li><strong>The <code>StreamBroadcaster</code></strong>: This is the real star of the show. Think of it as a secure, open-frequency radio broadcast. One agent (the &ldquo;leader&rdquo;) starts broadcasting intel (the LLM response stream), and any other agents on the same mission (the &ldquo;followers&rdquo;) can simply tune in and receive the same live feed. It&rsquo;s how we efficiently share the results of one expensive operation with many clients.</li>
</ul>
</li>
<li>
<p><strong>The <code>select</code> Statement</strong>: This is the system&rsquo;s &ldquo;situational awareness.&rdquo; A <code>select</code> block allows a goroutine to listen to multiple channels at once. It&rsquo;s like Batman in <em>The Dark Knight</em> watching dozens of monitors, waiting for a signal.</p>
<ul>
<li>The <code>janitor</code> uses <code>select</code> to wait for either its next cleaning interval (<code>ticker.C</code>) or a shutdown signal (<code>ctx.Done()</code>).</li>
<li>The <code>requestWorkerPool</code> uses <code>select</code> to wait for a new mission from the <code>requestQueue</code> or a shutdown signal.</li>
</ul>
</li>
<li>
<p><strong><code>sync.RWMutex</code>: The Consigliere</strong>: The <code>activeRequests</code> map is our &ldquo;family business&rdquo; ledger. Multiple goroutines need to read from it, and some need to write to it. The <code>sync.RWMutex</code> is our Tom Hagen from <em>The Godfather</em>.</p>
<ul>
<li><code>m.requestsLock.RLock()</code>: Many agents can <strong>ask</strong> what the plan is (a read lock). This is fast.</li>
<li><code>m.requestsLock.Lock()</code>: But only <strong>one</strong> agent can go into the room to <strong>change</strong> the plan (a write lock). All others must wait.</li>
<li>This primitive protects our shared data from being corrupted, ensuring the integrity of our operation.</li>
</ul>
</li>
<li>
<p><strong><code>context.Context</code> and <code>cancel()</code>: The Kill Switch</strong>: Every operation that might take time (API calls, LLM streams) is given a <code>context</code>. This context is our kill switch, like the neck bombs from <em>Suicide Squad</em>.</p>
<ul>
<li>When a request is cancelled or times out, we call its <code>cancel()</code> function. This sends a signal down through <code>ctx.Done()</code> to every goroutine working on that request. They see the signal, stop what they&rsquo;re doing, and clean up. &ldquo;Mission aborted. Get out now.&rdquo;</li>
<li>This gets even more interesting with the broadcast model. If a <strong>follower</strong> cancels, they are simply unsubscribed from the broadcast. If the <strong>leader</strong> cancels, we perform a clever deception: we send a fake cancellation message to <em>their</em> stream and unsubscribe them, but the underlying broadcast continues for any other followers. The mission must go on!</li>
</ul>
</li>
<li>
<p><strong><code>sync.WaitGroup</code>: The Rendezvous Point</strong>: In <code>streamer.go</code>, when a tool that streams its own output is called, it runs in its own goroutine. The main goroutine needs to wait for the tool to finish completely. A <code>sync.WaitGroup</code> is the rendezvous point, like in <em>Ocean&rsquo;s Eleven</em>. Danny Ocean tells the team (<code>wg.Add(1)</code>), and he waits at the exit (<code>wg.Wait()</code>) until every member has done their job and signaled they&rsquo;re clear (<code>defer wg.Done()</code>). This ensures perfect synchronization.</p>
</li>
</ol>
<h3 id="the-janitor-the-cleaner">The &ldquo;Janitor&rdquo;: The Cleaner
</h3><p>The <code>janitor</code> goroutine is our Mike Ehrmantraut from <em>Breaking Bad</em> or Winston from <em>John Wick</em>. It&rsquo;s a background process that runs periodically (<code>time.NewTicker</code>) to clean up messes. It finds requests that have been stuck in the queue too long (&ldquo;timed out in queue&rdquo;) or are taking too long to process (&ldquo;timed out during processing&rdquo;). It then purges their records, ensuring the system stays clean. No loose ends.</p>
<hr>
<h2 id="parallelism-executing-with-the-full-crew">Parallelism: Executing with the Full Crew
</h2><p>Parallelism is when we take our concurrent design and run it on a machine with multiple CPU cores. Now, multiple tasks aren&rsquo;t just being <em>managed</em> at once; they are <em>executing</em> at the exact same time.</p>
<p>In <code>manager.go</code>, this is controlled by our <strong>Worker Pool, Semaphores, and the Single-Flight Group</strong>. We don&rsquo;t want to unleash an infinite number of Hulks on our system; we need to control our resources.</p>
<h3 id="the-tools-of-parallelism">The Tools of Parallelism:
</h3><ol>
<li>
<p><strong>Worker Pool (<code>requestWorkerPool</code>)</strong>: Instead of a multi-stage assembly line, we now have a unified team of elite agents. The <code>requestWorkerPool</code> listens to the <code>requestQueue</code> and dispatches workers to handle missions <em>in parallel</em>, from start to finish.</p>
</li>
<li>
<p><strong>Semaphores (<code>chan struct{}</code>)</strong>: This is our resource management, our &ldquo;Nick Fury&rdquo; deciding who gets deployed. A semaphore is a channel used to limit how many goroutines can access a resource simultaneously.</p>
<ul>
<li><code>prepareSemaphore</code>: Its size (<code>config.MaxConcurrentRequests</code>) determines how many requests can be processed at the same time. This is like having the <em>Fast &amp; Furious</em> family&rsquo;s tech crew (Tej, Ramsey) all working on different hacks at once.</li>
<li><code>llmStreamSemaphore</code>: This one is critical. LLM streaming is expensive. This semaphore has a smaller limit (<code>config.MaxConcurrentLLMStreams</code>) to prevent us from overwhelming the LLM service. It ensures only a few &ldquo;heavy hitters&rdquo; (like Thor or The Hulk) are active at any given moment.</li>
</ul>
</li>
</ol>
<p>A worker from the pool must first acquire a &ldquo;slot&rdquo; from <code>prepareSemaphore</code> before it begins processing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6272a4">// This line blocks until a &#34;slot&#34; is free.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>m.prepareSemaphore <span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd;font-style:italic">struct</span>{}{}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>(<span style="color:#ff79c6">...</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// This defer ensures the &#34;slot&#34; is released when the worker is done.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() { <span style="color:#ff79c6">&lt;-</span>m.prepareSemaphore }()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">...</span>
</span></span><span style="display:flex;"><span>}()
</span></span></code></pre></div><p>Only the leader of a broadcast mission will attempt to acquire a slot from the <code>llmStreamSemaphore</code>.</p>
<h3 id="the-de-duplication-strategy-singleflight-and-the-streambroadcaster">The De-Duplication Strategy: <code>singleflight</code> and the <code>StreamBroadcaster</code>
</h3><p>This is our ace in the hole, the core of our new efficiency model. It&rsquo;s how we handle identical, simultaneous requests.</p>
<ul>
<li>
<p><strong>The Problem</strong>: A &ldquo;thundering herd.&rdquo; Multiple, identical requests arrive at once for data that isn&rsquo;t in the cache. Without a de-duplication strategy, we&rsquo;d launch parallel operations for every single request, all doing the same redundant, expensive work.</p>
</li>
<li>
<p><strong>The Solution</strong>: We combine <code>singleflight.Group</code> with our <code>StreamBroadcaster</code>. Think of it as setting up a secure press conference.</p>
<ol>
<li>
<p><strong>The First Request (The Leader)</strong>: When the first request for a specific topic (<code>cacheKey</code>) arrives, <code>m.sfGroup.Do()</code> allows it through. This request is now the <strong>Leader</strong>. Its job is to set up the press conference: it does the expensive preparation, creates a <code>StreamBroadcaster</code>, and starts the live feed (<code>initiateAndManageBroadcast</code>).</p>
</li>
<li>
<p><strong>Subsequent Requests (The Followers)</strong>: Any other requests for the <em>same topic</em> that arrive while the Leader is working are put on hold by <code>singleflight.Group</code>. They don&rsquo;t do any work themselves. They simply wait for the Leader to establish the broadcast.</p>
</li>
<li>
<p><strong>Tuning In</strong>: Once the Leader has set up the <code>StreamBroadcaster</code>, its <code>broadcastInfo</code> is shared with all the waiting Followers. Now, both the Leader and all the Followers call <code>broadcaster.Subscribe()</code> to get their own personal earpiece and &ldquo;tune in&rdquo; to the live feed. The <code>StreamBroadcaster</code> even has a <code>history</code> so that late-joiners get all the intel from the beginning.</p>
</li>
</ol>
</li>
</ul>
<p>This is a massive improvement. Instead of ten agents all trying to breach the same wall, one agent (the Leader) breaches it and then holds the door open for everyone else. The result of one expensive operation is shared live with many. Only the Leader is responsible for writing the final result to the cache, preventing redundant writes.</p>
<p>In short: <code>manager.go</code> uses concurrency to <strong>structure</strong> the work and parallelism to <strong>execute</strong> it, but its true genius lies in the <code>singleflight</code> and <code>StreamBroadcaster</code> combo, which ensures we do expensive work exactly once and share the results with ruthless efficiency.</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Go Chatbot
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/agentic/ts/main.7d3b06a3f9c7fc3f9e8edd384e9d4245f05cc3d94e687961eee37c1b5c98d939.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
